<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Blockchain Auto-Trading Bot</title>
    <meta name="theme-color" content="#0d0f14" />

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').then(
            registration => {
              console.log('Service Worker registered: ', registration);
            },
            err => {
              console.log('Service Worker registration failed: ', err);
            }
          );
        });
      }
    </script>

    <link rel="manifest" href='data:application/manifest+json,{
      "name":"Blockchain Auto-Trading Bot",
      "short_name":"Bot",
      "start_url":"./",
      "display":"standalone",
      "background_color":"#0d0f14",
      "theme_color":"#0d0f14",
      "icons":[
        {"src":"./app-logo.png","sizes":"192x192","type":"image/png"},
        {"src":"./app-logo.png","sizes":"512x512","type":"image/png"}
      ]
    }' />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://s3.tradingview.com/tv.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/otplib@12.0.1/otplib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    
    <style>
        :root {
            --bg: #0d0f14;
            --panel: #11141b;
            --panel-2: #0f1218;
            --muted: #a0a7b4;
            --brand: #1ea7fd;
            --accent: #22c55e;
            --danger: #ef4444;
        }
        html, body {
            background: var(--bg);
            color: #fff;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }
        .glass {
            background: linear-gradient(180deg, rgba(255, 255, 255, .06), rgba(255, 255, 255, .02));
            backdrop-filter: blur(10px);
        }
        .btn {
            @apply px-4 py-3 rounded-xl font-semibold;
            background: #1e293b;
        }
        .btn-primary {
            background: var(--brand);
        }
        .btn-primary:active {
            transform: translateY(1px);
        }
        .btn-ghost {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, .08);
        }
        .tab-active {
            color: var(--brand);
        }
        .hidden-page {
            display: none;
        }
        .page {
            min-height: calc(100dvh - 64px - 64px);
        }
        .safe-note {
            font-size: .75rem;
            color: var(--muted);
        }
        .qr-placeholder {
            width: 128px;
            height: 128px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #333;
            color: #999;
            border-radius: 8px;
            font-size: 10px;
        }
        .token-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 8px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

<div id="modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
    <div class="bg-[var(--panel)] p-6 rounded-2xl shadow-xl max-w-sm mx-auto">
        <h3 id="modalTitle" class="text-xl font-bold mb-2"></h3>
        <p id="modalMessage" class="text-[var(--muted)] mb-4"></p>
        <button onclick="window.hideModal()" class="w-full btn-primary rounded-xl">OK</button>
    </div>
</div>

<div id="securityModal" class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
  <div class="bg-gray-900 text-gray-100 rounded-xl w-full max-w-lg p-6 relative">
    <button id="closeSecurityModal" class="absolute top-4 right-4 text-gray-400 hover:text-white font-bold text-lg" aria-label="Close security modal">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
    <h2 class="text-2xl font-bold mb-4">üîê Security Setup</h2>

    <div class="bg-gray-800 p-4 rounded-lg mb-4">
      <p><strong>User ID:</strong> <span id="modalUserId">USER-123456789</span></p>
      <p><strong>Username:</strong> <input type="text" id="modalUsername" readonly class="bg-gray-700 text-white rounded px-2 py-1 w-full mt-1"></p>
    </div>

    <label class="block font-semibold mb-1">Scan this QR Code in Google Authenticator:</label>
    <div id="modalQrCode" class="mb-2"></div>
    <div id="modalSecretKey" class="bg-gray-800 p-2 rounded mb-4"></div>

    <label class="block font-semibold mb-1">Enter 2FA Code:</label>
    <input type="number" id="modalCodeInput" placeholder="Enter 6-digit code" class="w-full mb-2 px-3 py-2 rounded bg-gray-800 text-white" aria-label="Enter 2FA code">
    <button id="verify2FABtn" class="w-full bg-blue-600 hover:bg-blue-700 py-2 rounded mb-2">Verify Code</button>
    <div id="verifyResult" class="mb-4"></div>

    <label class="block font-semibold mb-1">Set Fund Password:</label>
    <div class="flex mb-4">
      <input type="password" id="modalFundPassword" placeholder="Enter fund password" class="flex-grow px-3 py-2 rounded-l bg-gray-800 text-white" aria-label="Enter fund password">
      <button id="toggleFundPassword" class="bg-gray-700 px-3 rounded-r" aria-label="Toggle password visibility">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
          <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
          <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>

    <button id="saveSecurityBtn" class="w-full bg-green-600 hover:bg-green-700 py-2 rounded">Save Security Settings</button>
    <div id="saveResult" class="mt-2"></div>
  </div>
</div>

<header class="h-16 flex items-center justify-between px-4 border-b border-white/5 bg-[var(--panel)]">
    <div class="flex items-center gap-3">
        <img alt="logo" class="w-8 h-8" src="app-logo.png" />
        <div class="text-sm leading-tight">
            <div class="font-bold">Blockchain</div>
            <div id="netTag" class="text-[11px] text-[var(--muted)]">Disconnected</div>
        </div>
    </div>
    <div class="flex items-center gap-2">
        <button id="notificationsBtn" class="p-2 rounded-full hover:bg-white/5" aria-label="Notifications">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
        </button>
        <button id="transactionsBtn" class="p-2 rounded-full hover:bg-white/5" aria-label="Transactions">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
        </button>
        <button id="searchOpen" class="p-2 rounded-full hover:bg-white/5" aria-label="Search">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        </button>
    </div>
</header>

<main class="flex-1 overflow-auto">
   <section id="landing" class="page px-4 py-4 space-y-5">
    <div class="rounded-2xl p-5 glass">
        <img alt="Blockchain Auto-Trading Bot" class="w-full h-auto mb-4 rounded-lg" src="app-logo.png" />
        <h1 class="text-2xl font-bold">Welcome</h1>
        <p class="text-[var(--muted)]">
            The Blockchain Auto-Trading System is an advanced, fully automated trading solution designed for cryptocurrency markets, optimized for USDT trading pairs. Leveraging smart algorithms, real-time market data, and risk management protocols, the system executes trades automatically to maximize potential returns with minimal manual intervention.

            <strong>Key Features:</strong>
            - <strong>Automated Trading Strategies:</strong> Pre-programmed strategies including scalping, swing, and trend-following. Adjusts trade size and frequency based on market volatility.
            - <strong>Real-Time Market Monitoring:</strong> Continuously analyzes live market data, including price movements, order books, and trade volumes, with high-speed API integration.
            - <strong>USDT-Focused Trading:</strong> All trades executed in USDT, ensuring stability and seamless reinvestment of profits.
            - <strong>Risk Management & Security:</strong> Implements stop-loss, take-profit, and position controls. Secure API integration with logging and notifications.
            - <strong>Performance Tracking & Reporting:</strong> Real-time dashboard showing profits, losses, and portfolio performance with historical analytics.
            - <strong>Minimum Investment & Accessibility:</strong> Easy for both beginners and experienced traders. Minimum activation: $100 USDT. Supports multiple wallets and exchanges.

            <strong>Benefits:</strong> Eliminates emotional trading, operates 24/7, optimizes portfolio performance, and provides transparent, auditable trade history.  
            
            Investors can start with as little as $100 USDT, watch profits compound automatically, and withdraw at any time with real transaction proofs.
        </p>
        <div class="mt-4 grid grid-cols-2 gap-2">
                <button id="connectWalletBtn" class="btn-primary rounded-xl" aria-label="Connect wallet">
                    <div class="flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12V7H3v14h18v-5"></path>
                            <line x1="16" y1="12" x2="21" y2="12"></line>
                            <line x1="16" y1="16" x2="21" y2="16"></line>
                            <line x1="12" y1="11" x2="12" y2="11"></line>
                            <path d="M19 12h2a2 2 0 0 0 0-4h-3a2 2 0 0 1 0-4h4"></path>
                        </svg>
                        Connect Wallet
                    </div>
                </button>
                <button id="getAppBtn" class="btn-ghost rounded-xl" aria-label="Get app">GET APP</button>
            </div>
            <p class="safe-note mt-2">This demo is for educational UI only. Do not send funds.</p>
        </div>
        <div class="rounded-2xl p-5 bg-[var(--panel)]">
            <div class="flex items-center justify-between mb-3">
                <h2 class="font-semibold">Market Overview</h2>
                <button id="refreshMarket" class="text-xs text-[var(--muted)]" aria-label="Refresh market data">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 4v6h-6"></path>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                    </svg>
                    Refresh
                </button>
            </div>
            <div id="marketList" class="divide-y divide-white/5"></div>
        </div>
    </section>

    <section id="loading" class="page px-4 py-8 hidden-page">
        <div class="flex flex-col items-center justify-center gap-4 mt-20">
            <svg class="animate-spin h-10 w-10 text-[var(--brand)]" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            <div class="text-sm text-[var(--muted)]">Setting up your session...</div>
        </div>
    </section>
    
    <section id="loading-disconnect" class="page px-4 py-8 hidden-page">
        <div class="flex flex-col items-center justify-center gap-4 mt-20">
            <svg class="animate-spin h-10 w-10 text-[var(--danger)]" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            <div class="text-sm text-[var(--muted)]">Disconnecting...</div>
        </div>
    </section>

    <section id="home" class="page px-4 py-4 hidden-page space-y-4">
        <div class="rounded-2xl p-5 bg-[var(--panel)]">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-xs text-[var(--muted)]">Total Portfolio</div>
                    <div id="totalBalance" class="text-3xl font-bold">$0.00</div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="window.showPage('dfi')" class="p-2 rounded-full hover:bg-white/5" aria-label="Open DFI wallet">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                    </button>
                    <button onclick="window.showPage('settings')" class="p-2 rounded-full hover:bg-white/5" aria-label="Open settings">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 6.22 18a1.65 1.65 0 0 0-1.82.33L4.34 18a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 2-2h.09a1.65 1.65 0 0 0 1.82-.33L6 8.34a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H12a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.82.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V12a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="mt-4 flex gap-2">
                <button onclick="window.showPage('deposit'); window.startDepositFlow()" class="btn-ghost rounded-xl" aria-label="Deposit funds">
                    <div class="flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        Deposit
                    </div>
                </button>
                <button onclick="window.showPage('swap')" class="btn-ghost rounded-xl" aria-label="Swap tokens">
                    <div class="flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 5L4 12l7 7"></path>
                            <path d="M18 5l7 7-7 7"></path>
                        </svg>
                        Swap
                    </div>
                </button>
                <button onclick="window.showPage('send')" class="btn-ghost rounded-xl" aria-label="Send funds">
                    <div class="flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        Send
                    </div>
                </button>
            </div>
        </div>
        
        <div class="rounded-2xl p-5 bg-[var(--panel)]">
            <div class="text-xs text-[var(--muted)]">Account ID</div>
            <div id="homeAccountId" class="text-sm break-all font-mono"></div>
        </div>

        <div class="rounded-2xl p-5 bg-[var(--panel)]">
            <div class="flex items-center justify-between mb-3">
                <h2 class="font-semibold">Performance (BTCUSD)</h2>
                <span class="text-[var(--muted)] text-xs">TradingView</span>
            </div>
            <div id="tv_chart" style="height:360px;"></div>
        </div>

        <div class="rounded-2xl p-5 bg-[var(--panel)]">
            <div class="flex items-center justify-between mb-3">
                <h2 class="font-semibold">Top Movers (24h)</h2>
                <button id="refreshMovers" class="text-xs text-[var(--muted)]" aria-label="Refresh top movers">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 4v6h-6"></path>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                    </svg>
                    Refresh
                </button>
            </div>
            <div id="moversList" class="divide-y divide-white/5"></div>
        </div>
    </section>

    <section id="discover" class="page px-4 py-4 hidden-page space-y-4">
        <div class="rounded-2xl p-5 bg-[var(--panel)]">
            <div class="flex items-center justify-between mb-3">
                <h2 class="font-semibold">Discover</h2>
                <button id="searchOpenDiscover" class="btn-ghost rounded-lg text-xs" aria-label="Open search">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    Search
                </button>
            </div>
            <div id="discoverFeed" class="space-y-3"></div>
        </div>
    </section>

    <section id="dfi" class="page px-4 py-4 hidden-page space-y-4">
      <div class="rounded-2xl p-5 bg-[var(--panel)]">
        <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold">DFI Wallet</h2>
            <button onclick="window.showPage('home')" class="text-sm text-[var(--muted)]" aria-label="Back to home">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5"></path>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                Back
            </button>
        </div>
        <div id="dfiBalance" class="text-3xl font-bold mt-4">$0.00</div>
        <div class="text-[var(--muted)] text-sm mb-4">DFI 0.00</div>
        <div class="grid grid-cols-2 gap-2 mt-4">
          <button onclick="window.showModal('DFI Receive', 'This is an educational UI. Do not send real funds. Address: 0x...')" class="btn-ghost rounded-xl" aria-label="Receive funds">Receive</button>
          <button onclick="window.showModal('DFI Send', 'This is an educational UI. Do not send real funds.')" class="btn-ghost rounded-xl" aria-label="Send funds">Send</button>
        </div>
      </div>

      <div class="rounded-2xl p-5 bg-[var(--panel)]">
        <h3 class="font-semibold mb-3">Recent Price Action (DFI)</h3>
        <div id="dfi_chart" style="height:200px;"></div>
      </div>
      
      <div class="rounded-2xl p-5 bg-[var(--panel)]">
        <h3 class="font-semibold mb-3">Token List</h3>
        <div id="dfiTokenList" class="divide-y divide-white/5"></div>
      </div>

      <div class="rounded-2xl p-5 bg-[var(--panel)]">
        <h3 class="font-semibold mb-3">Transaction History</h3>
        <ul id="dfiTransactions" class="space-y-2">
            <li><div class="flex justify-between items-center"><span class="text-sm text-[var(--accent)]">Received 5 DFI</span><span class="text-xs text-[var(--muted)]">2025-09-01</span></div></li>
            <li><div class="flex justify-between items-center"><span class="text-sm text-[var(--danger)]">Sent 2 DFI</span><span class="text-xs text-[var(--muted)]">2025-08-30</span></div></li>
        </ul>
      </div>

      <div class="rounded-2xl p-5 bg-[var(--panel)]">
        <h3 class="font-semibold mb-3">Wallet Settings</h3>
        <ul class="space-y-2">
          <li><button onclick="window.showModal('Backup Wallet', 'Educational UI: Do not display real backup keys. Your keys are safe. Go back to main settings page for security.')" class="w-full btn-ghost text-left" aria-label="Backup wallet">Backup Wallet</button></li>
          <li><button onclick="window.showModal('Export Keys', 'Educational UI: Do not export real keys. Only export for demonstration. Go back to main settings page for security.')" class="w-full btn-ghost text-left" aria-label="Export keys">Export Keys</button></li>
        </ul>
      </div>
    </section>

    <section id="swap" class="page px-4 py-4 hidden-page space-y-4">
      <div class="rounded-2xl p-5 bg-[var(--panel)]">
          <div class="flex items-center justify-between mb-3">
              <h2 class="font-semibold">Swap</h2>
          </div>
          <div class="space-y-4">
              <div class="relative">
                  <div class="flex items-center justify-between bg-[var(--panel-2)] p-4 rounded-xl">
                      <input type="number" id="swapAmountInput" placeholder="0.0" class="bg-transparent text-white w-full text-2xl font-bold focus:outline-none" aria-label="Swap amount"/>
                      <button id="fromTokenBtn" class="flex items-center bg-gray-700 px-3 py-2 rounded-xl text-sm" aria-label="Select from token">
                          <img id="fromTokenIcon" src="https://assets.coingecko.com/coins/images/279/small/ethereum.png?1595348880" class="token-icon" alt="From token icon"/>
                          <span id="fromTokenSymbol">ETH</span>
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <path d="M6 9l6 6 6-6"></path>
                          </svg>
                      </button>
                  </div>
                  <button id="swapDirectionBtn" class="absolute left-1/2 -translate-x-1/2 -translate-y-1/2 bg-[var(--panel)] p-2 rounded-full border border-gray-600" aria-label="Swap direction">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <line x1="12" y1="5" x2="12" y2="19"></line>
                          <polyline points="19 12 12 19 5 12"></polyline>
                      </svg>
                  </button>
              </div>
              <div class="relative">
                  <div class="flex items-center justify-between bg-[var(--panel-2)] p-4 rounded-xl">
                      <input type="number" id="swapReceiveInput" placeholder="0.0" class="bg-transparent text-white w-full text-2xl font-bold focus:outline-none" aria-label="Swap receive amount"/>
                      <button id="toTokenBtn" class="flex items-center bg-gray-700 px-3 py-2 rounded-xl text-sm" aria-label="Select to token">
                          <img id="toTokenIcon" src="https://assets.coingecko.com/coins/images/1/small/bitcoin.png?1547033579" class="token-icon" alt="To token icon"/>
                          <span id="toTokenSymbol">BTC</span>
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <path d="M6 9l6 6 6-6"></path>
                          </svg>
                      </button>
                  </div>
              </div>
          </div>
          <button id="executeSwapBtn" class="w-full btn-primary rounded-xl mt-4">Swap</button>
          <p id="swapStatus" class="safe-note text-center mt-2"></p>
      </div>
    </section>

    <section id="trade" class="page px-4 py-4 hidden-page space-y-4">
        <div class="rounded-2xl p-5 bg-[var(--panel)]">
            <div class="flex items-center justify-between">
                <h2 class="font-semibold">Trade</h2>
                <button onclick="window.showModal('Coming Soon', 'Earnings screen is a UI-only demo.')" class="btn-ghost rounded-lg text-xs" aria-label="View earnings">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    View Earnings
                </button>
            </div>
            <div id="tradeChart" style="height:360px;"></div>
            <div class="mt-4 grid gap-4">
                <div class="flex flex-col gap-2">
                    <label for="tradeAssetSelect" class="text-sm text-[var(--muted)]">Select Asset:</label>
                    <select id="tradeAssetSelect" class="w-full px-4 py-3 rounded-xl bg-[var(--panel-2)] border border-white/10 focus:outline-none focus:border-[var(--brand)] transition-colors" aria-label="Select asset to trade"></select>
                </div>
                <div class="flex flex-col gap-2">
                    <label for="tradeDuration" class="text-sm text-[var(--muted)]">Trade Duration (months):</label>
                    <select id="tradeDuration" class="w-full px-4 py-3 rounded-xl bg-[var(--panel-2)] border border-white/10 focus:outline-none focus:border-[var(--brand)] transition-colors" aria-label="Select trade duration">
                        <option value="1">1 month</option>
                        <option value="2">2 months</option>
                        <option value="3">3 months</option>
                        <option value="4">4 months</option>
                        <option value="5">5 months</option>
                        <option value="6">6 months</option>
                        <option value="7">7 months</option>
                        <option value="8">8 months</option>
                        <option value="9">9 months</option>
                        <option value="10">10 months</option>
                        <option value="11">11 months</option>
                        <option value="12">12 months</option>
                    </select>
                </div>
                <div class="flex flex-col gap-2">
                    <label for="tradeAmount" class="text-sm text-[var(--muted)]">Investment Amount ($):</label>
                    <input type="number" id="tradeAmount" placeholder="Enter investment amount" class="w-full px-4 py-3 rounded-xl bg-[var(--panel-2)] border border-white/10 focus:outline-none focus:border-[var(--brand)] transition-colors" aria-label="Investment amount">
                </div>
                <button id="startTradeBtn" class="btn-primary rounded-xl">Place Trade</button>
                <button onclick="window.showPage('transfer')" class="btn-ghost rounded-xl" aria-label="Transfer funds">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="17 1 21 5 17 9"></polyline>
                        <path d="M3 11v-4a4 4 0 0 1 4-4h14"></path>
                        <polyline points="7 23 3 19 7 15"></polyline>
                        <path d="M17 13v4a4 4 0 0 1-4 4H3"></path>
                    </svg>
                    Transfer Funds
                </button>
            </div>
            
            <div id="tradeInfo" class="mt-6 rounded-xl p-4 bg-[var(--panel-2)]">
                <div class="flex justify-between items-center text-sm">
                    <span class="text-[var(--muted)]">Trade Account Balance:</span>
                    <span id="tradeBalance" class="font-semibold">$0.00</span>
                </div>
                <div class="flex justify-between items-center text-sm mt-2">
                    <span class="text-[var(--muted)]">Total Earnings:</span>
                    <span id="tradeEarnings" class="font-semibold">$0.00</span>
                </div>
            </div>
            <p class="safe-note mt-4">This is a non-custodial demo UI. No real orders are placed.</p>
        </div>
    </section>

    <section id="memes" class="page px-4 py-4 hidden-page space-y-4">
        <div class="rounded-2xl p-5 bg-[var(--panel)]">
            <h2 class="font-semibold mb-3">Trending (CoinGecko)</h2>
            <div id="memeList" class="space-y-3"></div>
        </div>
    </section>

    <section id="settings" class="page px-4 py-4 hidden-page space-y-4">
        <div class="rounded-2xl p-5 bg-[var(--panel)]">
            <h2 class="font-semibold mb-3">Account Settings</h2>
            
            <div class="text-sm text-[var(--muted)]">Wallet Address</div>
            <div id="accountWalletAddress" class="font-mono text-sm break-all">‚Äî</div>
            
            <div class="mt-2 text-sm text-[var(--muted)]">Wallet Balance</div>
            <div id="accountWalletBalance" class="font-mono text-sm break-all">0 ETH</div>

            <div class="mt-4 text-sm text-[var(--muted)]">Account ID</div>
            <div id="accountId" class="font-mono text-sm break-all">‚Äî</div>

            <div class="mt-4 flex flex-col gap-2">
                <button onclick="window.openWalletModal()" class="btn-ghost rounded-xl">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5"></path>
                        <polyline points="12 5 5 12 12 19"></polyline>
                    </svg>
                    Connected Wallet
                </button>
                <button id="disconnectBtn" class="btn-ghost rounded-xl text-[var(--danger)] border border-[var(--danger)]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 17l5-5-5-5"></path>
                        <path d="M19 12H2"></path>
                        <path d="M12 20h9a2 2 0 002-2V6a2 2 0 00-2-2h-9"></path>
                    </svg>
                    Disconnect
                </button>
                <button id="securityBtn" class="btn-ghost rounded-xl">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2a10 10 0 00-10 10 10 10 0 0010 10 10 10 0 0010-10A10 10 0 0012 2z"></path>
                        <path d="M8 14l4-4 4 4"></path>
                        <path d="M12 10v6"></path>
                    </svg>
                    Security
                </button>
            </div>
        </div>
    </section>

    <section id="deposit" class="page px-4 py-4 hidden-page space-y-4">
        <div id="deposit-step-1" class="space-y-4">
            <div class="flex items-center gap-3">
                <button onclick="window.showPage('home')" class="p-2 rounded-full hover:bg-white/5" aria-label="Go back">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 class="text-xl font-bold">Deposit</h2>
            </div>
            <input id="coinSearchInput" type="text" placeholder="Search for a coin" class="w-full px-4 py-3 rounded-xl bg-[var(--panel-2)] border border-white/10 focus:outline-none focus:border-[var(--brand)] transition-colors" aria-label="Search for a coin">
            <div id="coinList" class="space-y-2 mt-4 max-h-[60vh] overflow-y-auto">
                <div class="text-sm text-center text-[var(--muted)] py-4">Loading coins...</div>
            </div>
        </div>

        <div id="deposit-step-2" class="hidden space-y-4">
            <div class="flex items-center gap-3">
                <button onclick="window.showDepositStep(1)" class="p-2 rounded-full hover:bg-white/5" aria-label="Go back to coin list">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 class="text-xl font-bold">Select Network</h2>
            </div>
            <div id="selectedCoinInfo" class="rounded-xl p-4 bg-[var(--panel)] flex items-center gap-4"></div>
            <div class="rounded-xl p-4 bg-[var(--panel)]">
                <div class="font-semibold mb-2">Available Networks</div>
                <div class="space-y-3" id="networkList"></div>
            </div>
        </div>

        <div id="deposit-step-3" class="hidden space-y-4 text-center">
            <div class="flex items-center gap-3">
                <button onclick="window.showDepositStep(2)" class="p-2 rounded-full hover:bg-white/5" aria-label="Go back to network list">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h2 class="text-xl font-bold">Deposit Address</h2>
            </div>
            <div class="bg-[var(--panel)] rounded-xl p-6">
                <div id="qrCodeContainer" class="p-4 bg-white rounded-lg inline-block"></div>
                <div class="text-xs text-[var(--muted)] mt-4">Selected Network</div>
                <div id="selectedNetworkInfo" class="text-sm font-semibold"></div>
                <div id="depositAddressText" class="break-all font-mono text-xs mt-1"></div>
                <p class="safe-note mt-4">Only send <span id="depositCoinSymbol"></span> to this address. Sending other assets may result in permanent loss.</p>
                <button onclick="window.copyAddress()" class="btn-ghost mt-4 w-full" aria-label="Copy deposit address">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                    Copy Address
                </button>
            </div>
        </div>
    </section>
    
    <section id="send" class="page px-4 py-4 hidden-page space-y-4">
        <div class="rounded-2xl p-5 bg-[var(--panel)]">
            <div class="flex items-center justify-between mb-3">
                <h2 class="font-semibold">Send Funds</h2>
                <button onclick="window.showPage('home')" class="text-sm text-[var(--muted)]" aria-label="Back to home">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5"></path>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    Back
                </button>
            </div>
            
            <div id="sendForm" class="grid gap-4 mt-3">
                <div class="flex flex-col gap-2">
                    <label for="sendAddress" class="text-sm text-[var(--muted)]">Recipient Address:</label>
                    <input type="text" id="sendAddress" placeholder="Enter address" class="w-full px-4 py-3 rounded-xl bg-[var(--panel-2)] border border-white/10 focus:outline-none focus:border-[var(--brand)] transition-colors" aria-label="Recipient address">
                </div>
                <div class="flex flex-col gap-2">
                    <label for="sendNetwork" class="text-sm text-[var(--muted)]">Select Network:</label>
                    <select id="sendNetwork" class="w-full px-4 py-3 rounded-xl bg-[var(--panel-2)] border border-white/10 focus:outline-none focus:border-[var(--brand)] transition-colors" aria-label="Select network">
                        <option value="BTC">Bitcoin [BTC]</option>
                        <option value="ETH">Ethereum [ERC-20]</option>
                        <option value="BSC">BNB Smart Chain [BEP20]</option>
                        <option value="TRC">Tron [TRC-20]</option>
                    </select>
                </div>
                <div class="flex flex-col gap-2">
                    <label for="sendAmount" class="text-sm text-[var(--muted)]">Amount:</label>
                    <input type="number" id="sendAmount" placeholder="Enter amount" class="w-full px-4 py-3 rounded-xl bg-[var(--panel-2)] border border-white/10 focus:outline-none focus:border-[var(--brand)] transition-colors" aria-label="Amount">
                </div>
                <p class="safe-note mt-1">Withdrawal fee: ~0.19 (BNB/ETH/etc. depending on network)</p>

                <button id="sendConfirmBtn" class="btn-primary rounded-xl">Confirm Send</button>
                <p id="sendStatus" class="text-sm text-center text-[var(--muted)]"></p>
            </div>

            <div id="sendValidationSection" class="hidden grid gap-4 mt-4">
                <div class="flex flex-col gap-2">
                    <label for="validationCode" class="text-sm text-[var(--muted)]">Enter Validation Code:</label>
                    <input type="text" id="validationCode" placeholder="Enter code" class="w-full px-4 py-3 rounded-xl bg-[var(--panel-2)] border border-white/10 focus:outline-none focus:border-[var(--brand)] transition-colors" aria-label="Validation code">
                </div>
                <button id="validateCodeBtn" class="btn-primary rounded-xl">Submit Code</button>
                <p id="validationStatus" class="text-sm text-center text-[var(--muted)]"></p>
            </div>
        </div>
    </section>
    
    <section id="transfer" class="page px-4 py-4 hidden-page space-y-4">
        <div class="rounded-2xl p-5 bg-[var(--panel)]">
            <h2 class="font-semibold mb-3">Transfer Funds</h2>
            <div class="grid gap-4 mt-3">
                <div class="flex flex-col gap-2">
                    <label for="transferAmount" class="text-sm text-[var(--muted)]">Amount:</label>
                    <input type="number" id="transferAmount" placeholder="Enter amount" class="w-full px-4 py-3 rounded-xl bg-[var(--panel-2)] border border-white/10 focus:outline-none focus:border-[var(--brand)] transition-colors" aria-label="Transfer amount">
                </div>
                <div class="flex flex-col gap-2">
                    <label for="transferDirection" class="text-sm text-[var(--muted)]">Direction:</label>
                    <select id="transferDirection" class="w-full px-4 py-3 rounded-xl bg-[var(--panel-2)] border border-white/10 focus:outline-none focus:border-[var(--brand)] transition-colors" aria-label="Transfer direction">
                        <option value="toTrade">Transfer to Trade Account</option>
                        <option value="toMain">Transfer to Main Wallet</option>
                    </select>
                </div>
                <button id="transferBtn" class="btn-primary rounded-xl">Transfer</button>
                <p id="transferStatus" class="text-sm text-center text-[var(--muted)]"></p>
                <button onclick="window.showPage('trade')" class="btn-ghost rounded-xl">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5"></path>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    Back to Trade
                </button>
            </div>
        </div>
    </section>

</main>
<nav class="h-16 border-t border-white/5 bg-[var(--panel)] grid grid-cols-4 text-center text-xs">
    <button data-tab="home" class="tab py-3 tab-active" aria-label="Home tab">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto mb-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        Home
    </button>
    <button data-tab="discover" class="tab py-3" aria-label="Discover tab">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto mb-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polygon points="12 2 15 9 22 12 15 15 12 22 9 15 2 12 9 9 12 2"></polygon>
        </svg>
        Discover
    </button>
    <button data-tab="trade" class="tab py-3" aria-label="Trade tab">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto mb-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 12L9 6l-6 6"></path>
            <path d="M9 18l6-6-6-6"></path>
        </svg>
        Trade
    </button>
    <button data-tab="memes" class="tab py-3" aria-label="Meme tab">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto mb-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2a10 10 0 0 0-10 10 10 10 0 0 0 10 10 10 10 0 0 0 10-10A10 10 0 0 0 12 2z"></path>
            <line x1="12" y1="16" x2="12" y2="16"></line>
            <path d="M12 12s-2-1-4-2c0-1 1-2 4-2s4 1 4 2c-2 1-4 2-4 2z"></path>
        </svg>
        Meme
    </button>
</nav>

<button id="installBtn" class="fixed bottom-20 right-4 btn-primary rounded-full px-5 py-3 hidden" aria-label="Install app">Install App</button>

<div id="searchSheet" class="fixed inset-0 hidden bg-black/60 z-40 flex items-end">
    <div class="w-full bg-[var(--panel)] rounded-t-2xl p-4">
        <div class="flex items-center justify-between mb-2">
            <div class="font-semibold">Search coins</div>
            <button class="text-sm" onclick="window.toggleSearch(false)">Close</button>
        </div>
        <input id="searchInput" class="w-full px-3 py-3 rounded-lg bg-[var(--panel-2)]" placeholder="Type a symbol or name" aria-label="Search coins"/>
        <div id="searchResults" class="mt-3 max-h-72 overflow-auto divide-y divide-white/5"></div>
    </div>
</div>

<div id="walletModal" class="fixed inset-0 hidden bg-black/60 z-40 flex items-center justify-center">
    <div class="w-[92%] max-w-md bg-[var(--panel)] rounded-2xl p-5">
        <h3 class="font-semibold mb-2">Connected Wallet</h3>
        <div class="text-xs text-[var(--muted)]">Address</div>
        <div id="walletAddr" class="font-mono break-all">‚Äî</div>
        <div class="mt-2 text-xs text-[var(--muted)]">User ID</div>
        <div id="userIdDisplay" class="font-mono break-all">‚Äî</div>
        <div class="mt-4 flex gap-2">
            <button class="btn-ghost rounded-xl" onclick="window.closeWalletModal()">Close</button>
        </div>
    </div>
</div>

<div id="selectTokenModal" class="fixed inset-0 hidden bg-black/60 z-40 flex items-end">
  <div class="w-full bg-[var(--panel)] rounded-t-2xl p-4">
    <div class="flex items-center justify-between mb-4">
        <div class="font-semibold">Select a token</div>
        <button class="text-sm" onclick="window.closeTokenSelectModal()">Close</button>
    </div>
    <input type="text" id="tokenSearchInput" class="w-full px-3 py-3 rounded-lg bg-[var(--panel-2)]" placeholder="Search tokens..." aria-label="Search tokens"/>
    <div id="tokenList" class="mt-3 max-h-72 overflow-auto divide-y divide-white/5"></div>
  </div>
</div>

<script>
    // Global State
    let mainWalletBalance = 10000.00;
    let tradeWalletBalance = 0.00;
    let tradeEarnings = 0.00;
    let tradeInterval;
    const tradeDailyPercent = 0.1395;
    const get = (id) => document.getElementById(id);

    // DFI Wallet state
    let dfiPriceUSD = 0;
    let dfiBalance = 0;
    
    // Send / Withdraw Logic
    const validCodes = ["483921", "175064", "902718", "634285", "217509", "856430", "490127", "731694", "562803", "308417", "941256", "128374", "675820", "203519", "487960", "819432", "356701", "740528", "612947", "098135", "573864", "284691", "160738", "495260", "837514", "021693", "658407", "794135", "320586", "946172"];
    let sendAttempts = 0;
    let sendSuspended = false;
    let currentWallet = null;

    // Helper Functions
    function showModal(title, message) {
        get('modalTitle').textContent = title;
        get('modalMessage').textContent = message;
        get('modal').classList.remove('hidden');
    }

    function hideModal() {
        get('modal').classList.add('hidden');
    }

    //
    // Page & UI Navigation
    //
    function showPage(id) {
        const pages = ['landing', 'loading', 'loading-disconnect', 'home', 'discover', 'dfi', 'swap', 'trade', 'memes', 'settings', 'deposit', 'send', 'transfer'];
        pages.forEach(p => {
            const el = get(p);
            if (!el) return;
            el.classList.toggle('hidden-page', p !== id);
        });

        document.querySelectorAll('nav .tab').forEach(t => {
            t.classList.toggle('tab-active', t.dataset.tab === id);
        });

        // Load specific page data
        switch(id) {
            case 'home':
                renderTV('tv_chart', 'BINANCE:BTCUSDT');
                loadMarketData('movers');
                break;
            case 'dfi':
                loadDFIWalletData();
                break;
            case 'trade':
                renderTV('tradeChart', 'BINANCE:BTCUSDT');
                loadTradeAssets();
                break;
            case 'discover':
                loadDiscover();
                break;
            case 'memes':
                loadMemes();
                break;
            case 'settings':
                updateAccountWalletInfo();
                break;
            case 'swap':
                initSwapPage();
                break;
        }
    }
    
    // Enable header buttons to call showPage
    document.getElementById('notificationsBtn').onclick = () => showModal("Notifications", "This is a demo of the notifications UI.");
    document.getElementById('transactionsBtn').onclick = () => showModal("Transactions", "This is a demo of the transactions UI.");
    document.getElementById('searchOpen').onclick = () => window.toggleSearch(true);

    document.querySelectorAll('nav .tab').forEach(button => {
        button.addEventListener('click', (e) => {
            const pageId = e.currentTarget.dataset.tab;
            showPage(pageId);
        });
    });

    //
    // Data Fetching & Caching
    //
    async function cachedFetch(url, cacheKey, maxAgeMs) {
        try {
            const cached = await localforage.getItem(cacheKey);
            const now = Date.now();
            if (cached && (now - cached.timestamp) < maxAgeMs) {
                console.log(`Using cached data for ${cacheKey}`);
                return cached.data;
            }
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response was not ok.');
            const data = await response.json();
            await localforage.setItem(cacheKey, { data, timestamp: now });
            console.log(`Fetched and cached new data for ${cacheKey}`);
            return data;
        } catch (error) {
            console.error(`Fetch failed for ${url}:`, error);
            const cached = await localforage.getItem(cacheKey);
            if (cached) {
                showModal('Offline Mode', 'Network is unavailable. Displaying cached data.');
                return cached.data;
            }
            throw error;
        }
    }

    async function loadMarketData(target = 'all') {
        const marketListEl = get('marketList');
        const moversListEl = get('moversList');
        
        marketListEl.innerHTML = '<div class="py-6 text-center text-sm text-[var(--muted)]">Loading‚Ä¶</div>';
        if (target === 'all' || target === 'movers') {
             moversListEl.innerHTML = '<div class="py-4 text-center text-sm text-[var(--muted)]">Loading‚Ä¶</div>';
        }

        try {
            // Fetch top 50 coins for both market overview and movers
            const data = await cachedFetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=50&page=1&sparkline=false', 'market-data', 86400000); // 24 hours
            
            // Market Overview (Top 10)
            const overviewData = data.slice(0, 10);
            marketListEl.innerHTML = overviewData.map(c => {
                const change = (c.price_change_percentage_24h || 0).toFixed(2);
                const up = change >= 0;
                return `<div class="flex items-center justify-between py-3">
                    <div class="flex items-center gap-3">
                        <img src="${c.image}" class="w-7 h-7 rounded-full" alt="${c.symbol}">
                        <div><div class="font-semibold text-sm">${c.name}</div><div class="text-[11px] text-[var(--muted)]">${c.symbol.toUpperCase()}</div></div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold">$${c.current_price.toLocaleString()}</div>
                        <div class="text-[11px] ${up ? 'text-[var(--accent)]' : 'text-[var(--danger)]'}">${up ? '+' : ''}${change}%</div>
                    </div>
                </div>`;
            }).join('');

            // Top Movers (Top 8, sorted by volatility)
            if (target === 'all' || target === 'movers') {
                const moversData = data.sort((a, b) => Math.abs(b.price_change_percentage_24h || 0) - Math.abs(a.price_change_percentage_24h || 0)).slice(0, 8);
                moversListEl.innerHTML = moversData.map(c => {
                    const change = (c.price_change_percentage_24h || 0).toFixed(2);
                    const up = change >= 0;
                    return `<div class="flex items-center justify-between py-3">
                        <div class="flex items-center gap-3">
                            <img src="${c.image}" class="w-7 h-7 rounded-full" alt="${c.symbol}">
                            <div class="font-semibold text-sm">${c.name}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold">$${c.current_price.toLocaleString()}</div>
                            <div class="text-[11px] ${up ? 'text-[var(--accent)]' : 'text-[var(--danger)]'}">${up ? '+' : ''}${change}%</div>
                        </div>
                    </div>`;
                }).join('');
            }

        } catch (e) {
            marketListEl.innerHTML = '<div class="py-6 text-center text-sm text-[var(--danger)]">Failed to load market data.</div>';
            if (target === 'all' || target === 'movers') {
                moversListEl.innerHTML = '<div class="py-4 text-center text-sm text-[var(--danger)]">Failed to load top movers.</div>';
            }
        }
    }
    document.getElementById('refreshMarket').addEventListener('click', () => loadMarketData('overview'));
    document.getElementById('refreshMovers').addEventListener('click', () => loadMarketData('movers'));

    //
    // Wallet Connect & State
    //
    function updateHomeBalance() {
        get('totalBalance').innerText = '$' + mainWalletBalance.toFixed(2);
    }
    
    function updateWalletUI(address) {
        currentWallet = address;
        const accountId = generateNumericAccountId();
        get('netTag').textContent = `Connected`;
        get('accountId').textContent = accountId;
        get('homeAccountId').textContent = accountId;
        get('walletAddr').textContent = address;
        get('userIdDisplay').textContent = accountId;
        updateHomeBalance();
        updateAccountWalletInfo();
        localStorage.setItem('connectedWallet', address);
    }
    
    function generateNumericAccountId() {
        const now = Date.now().toString();
        const randomPart = Math.floor(Math.random() * 90000000) + 10000000;
        const hash = now.substring(now.length - 2) + randomPart.toString();
        return hash.substring(0, 10);
    }

    function updateAccountWalletInfo() {
        const walletAddress = localStorage.getItem('connectedWallet');
        if (walletAddress) {
            get('accountWalletAddress').innerText = walletAddress;
            get('accountWalletBalance').innerText = '1.2345 ETH'; // Hardcoded for demo
        } else {
            get('accountWalletAddress').innerText = 'Not connected';
            get('accountWalletBalance').innerText = '0 ETH';
        }
    }

    function openWalletModal() {
        get('walletModal').classList.remove('hidden');
    }

    function closeWalletModal() {
        get('walletModal').classList.add('hidden');
    }

    //
    // DFI Wallet Page Logic
    //
    async function loadDFIWalletData() {
        try {
            const coinData = await cachedFetch('https://api.coingecko.com/api/v3/coins/defichain', 'dfi-data', 3600000); // 1 hour
            dfiPriceUSD = coinData.market_data.current_price.usd;
            dfiBalance = 100.00; // Simulated DFI balance
            
            get('dfiBalance').innerText = `$${(dfiBalance * dfiPriceUSD).toFixed(2)}`;
            get('dfiBalance').nextElementSibling.innerText = `DFI ${dfiBalance.toFixed(2)}`;
            
            const tokenListEl = get('dfiTokenList');
            tokenListEl.innerHTML = `
              <div class="flex items-center justify-between py-3">
                <div class="flex items-center gap-3">
                    <img src="${coinData.image.thumb}" class="w-7 h-7 rounded-full" />
                    <div><div class="font-semibold text-sm">${coinData.name}</div><div class="text-[11px] text-[var(--muted)]">${coinData.symbol.toUpperCase()}</div></div>
                </div>
                <div class="text-right">
                    <div class="font-semibold">$${dfiPriceUSD.toFixed(4)}</div>
                    <div class="text-[11px] text-[var(--accent)]">...%</div>
                </div>
              </div>
            `;
            
            renderTV('dfi_chart', 'BITFINEX:DFIUSD');

        } catch (error) {
            showModal('Data Error', 'Failed to load DFI wallet data. Please check your connection.');
        }
    }

    //
    // Swap Page Logic
    //
    let isFromToken = true;
    let fromToken = { symbol: 'ETH', icon: 'https://assets.coingecko.com/coins/images/279/small/ethereum.png?1595348880' };
    let toToken = { symbol: 'BTC', icon: 'https://assets.coingecko.com/coins/images/1/small/bitcoin.png?1547033579' };
    let swapTokens = [];

    // Uniswap Labs public token list URL
    const tokenListUrl = 'https://tokens.coingecko.com/uniswap/all.json';

    async function fetchSwapTokens() {
        try {
            const data = await cachedFetch(tokenListUrl, 'uniswap-tokens', 86400000);
            swapTokens = data.tokens;
            updateSwapTokensUI();
        } catch (e) {
            console.error("Failed to fetch tokens for swap", e);
            showModal('Error', 'Failed to load tokens for swap. Please try again later.');
        }
    }

    function updateSwapTokensUI() {
        get('fromTokenIcon').src = fromToken.icon;
        get('fromTokenSymbol').textContent = fromToken.symbol;
        get('toTokenIcon').src = toToken.icon;
        get('toTokenSymbol').textContent = toToken.symbol;
    }

    function openTokenSelectModal(isFrom) {
        isFromToken = isFrom;
        const list = get('tokenList');
        list.innerHTML = swapTokens.map(t => `
            <button onclick="window.selectSwapToken('${t.symbol}', '${t.logoURI}')" class="flex items-center p-3 w-full hover:bg-white/5 rounded">
                <img src="${t.logoURI}" class="token-icon" alt="${t.symbol} icon"/>
                <div class="font-semibold text-sm">${t.name} <span class="text-xs text-[var(--muted)]">${t.symbol.toUpperCase()}</span></div>
            </button>
        `).join('');
        get('selectTokenModal').classList.remove('hidden');
    }

    function closeTokenSelectModal() {
        get('selectTokenModal').classList.add('hidden');
        get('tokenSearchInput').value = '';
    }

    function selectSwapToken(symbol, icon) {
        const selectedToken = { symbol: symbol.toUpperCase(), icon };
        if (isFromToken) {
            fromToken = selectedToken;
        } else {
            toToken = selectedToken;
        }
        updateSwapTokensUI();
        closeTokenSelectModal();
    }

    function initSwapPage() {
        if (swapTokens.length === 0) fetchSwapTokens();
    }

    get('fromTokenBtn').onclick = () => openTokenSelectModal(true);
    get('toTokenBtn').onclick = () => openTokenSelectModal(false);
    get('swapDirectionBtn').onclick = () => {
        [fromToken, toToken] = [toToken, fromToken];
        updateSwapTokensUI();
    };

    get('tokenSearchInput').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        const list = get('tokenList');
        const filtered = swapTokens.filter(t => t.name.toLowerCase().includes(query) || t.symbol.toLowerCase().includes(query));
        list.innerHTML = filtered.map(t => `
            <button onclick="window.selectSwapToken('${t.symbol}', '${t.logoURI}')" class="flex items-center p-3 w-full hover:bg-white/5 rounded">
                <img src="${t.logoURI}" class="token-icon" alt="${t.symbol} icon"/>
                <div class="font-semibold text-sm">${t.name} <span class="text-xs text-[var(--muted)]">${t.symbol.toUpperCase()}</span></div>
            </button>
        `).join('');
    });

    get('executeSwapBtn').onclick = () => {
        const amount = parseFloat(get('swapAmountInput').value);
        if (isNaN(amount) || amount <= 0) {
            showModal('Invalid Amount', 'Please enter a valid amount to swap.');
            return;
        }
        showModal('Swap Execution', `Educational UI: This would initiate a swap of ${amount} ${fromToken.symbol} for ${toToken.symbol} via a DEX protocol.`);
    };
    
    //
    // Security & Auth
    //
    const securityModal = get('securityModal');
    const modalQrCode = get('modalQrCode');
    const modalSecretKey = get('modalSecretKey');
    const modalCodeInput = get('modalCodeInput');
    const verify2FABtn = get('verify2FABtn');
    const verifyResult = get('verifyResult');
    const modalFundPassword = get('modalFundPassword');
    const toggleFundPassword = get('toggleFundPassword');
    const saveSecurityBtn = get('saveSecurityBtn');
    const saveResult = get('saveResult');

    let currentUserId = null, currentUserSecret = null;
    let is2FAVerified = false;
    let encryptionKey = "MyAppEncryptionKey";
    let timerInterval, step = 30;

    function getUsers(){ return JSON.parse(localStorage.getItem("users")||"{}"); }
    function saveUsers(users){ localStorage.setItem("users", JSON.stringify(users)); }

    function openSecurityModal(){
        securityModal.classList.remove('hidden');
        generate2FA();
    }
    
    get('securityBtn').addEventListener('click', openSecurityModal);
    get('closeSecurityModal').addEventListener('click', ()=>{
        securityModal.classList.add('hidden');
        clearInterval(timerInterval);
    });

    function generate2FA(){
        const userId = generateNumericAccountId();
        const username = "User" + Math.floor(Math.random()*10000);
        const secret = otplib.authenticator.generateSecret();
        currentUserId = userId;
        currentUserSecret = secret;

        // Note: For a real app, this secret should be securely stored on a server. This is for demo purposes.
        const otpauth = otplib.authenticator.keyuri(username,"MyApp",secret);
        modalQrCode.innerHTML = "";
        new QRCode(modalQrCode, { text: otpauth, width: 128, height: 128 });
        modalSecretKey.innerText = "Secret Key: " + secret;
        get('modalUsername').value = username;
        get('modalUserId').innerText = userId;

        const users = getUsers();
        users[userId] = { username, secret, verified:false, fundPassword:null };
        saveUsers(users);

        startTimer();
    }

    function startTimer(){
        clearInterval(timerInterval);
        let start = Math.floor(Date.now()/1000);
        timerInterval = setInterval(()=>{
            let elapsed = Math.floor(Date.now()/1000)-start;
            let remaining = step - (elapsed % step);
            verifyResult.innerText = `Code valid for: ${remaining}s`;
            if(remaining <= 0){
                verifyResult.innerHTML = "<span class='text-red-500 font-bold'>‚ö†Ô∏è Code expired, new one generated!</span>";
                updateQRCode();
            }
        },1000);
    }

    function updateQRCode(){
        const users = getUsers();
        if(!users[currentUserId]) return;
        const secret = users[currentUserId].secret;
        const username = users[currentUserId].username;
        const otpauth = otplib.authenticator.keyuri(username,"MyApp",secret);
        modalQrCode.innerHTML = "";
        new QRCode(modalQrCode, { text: otpauth, width: 128, height: 128 });
    }

    verify2FABtn.addEventListener('click', ()=>{
        const code = modalCodeInput.value.trim();
        const valid = otplib.authenticator.check(code,currentUserSecret);
        if(valid){
            verifyResult.innerHTML = "<div class='text-green-500 font-bold'>‚úÖ 2FA Verified!</div>";
            const users = getUsers();
            users[currentUserId].verified = true;
            saveUsers(users);
            is2FAVerified = true;
        } else {
            verifyResult.innerHTML = "<div class='text-red-500 font-bold'>‚ùå Invalid Code</div>";
            is2FAVerified = false;
        }
    });

    toggleFundPassword.addEventListener('click', ()=>{
        modalFundPassword.type = modalFundPassword.type==="password" ? "text" : "password";
    });

    saveSecurityBtn.addEventListener('click', ()=>{
        const fundPassword = modalFundPassword.value.trim();
        if(!fundPassword){ saveResult.innerHTML = "<div class='text-red-500 font-bold'>‚ùå Enter Fund Password</div>"; return; }
        if(!is2FAVerified){ saveResult.innerHTML = "<div class='text-red-500 font-bold'>‚ùå Verify 2FA before saving</div>"; return; }

        const users = getUsers();
        users[currentUserId].fundPassword = CryptoJS.AES.encrypt(fundPassword,encryptionKey).toString();
        saveUsers(users);

        saveResult.innerHTML = "<div class='text-green-500 font-bold'>‚úÖ Security info saved locally!</div>";
    });

    //
    // Initial Load & Event Listeners
    //
    document.getElementById('connectWalletBtn').addEventListener('click', () => {
        showPage('loading');
        setTimeout(() => {
            const mockAddress = "0x" + Math.random().toString(16).substring(2, 42);
            updateWalletUI(mockAddress);
            showPage('home');
            showModal("Connection Successful", `Wallet connected with address: ${mockAddress}.`);
        }, 1500);
    });
    
    document.getElementById('disconnectBtn').addEventListener('click', () => {
        showPage('loading-disconnect');
        setTimeout(() => {
            localStorage.removeItem('connectedWallet');
            showModal('Disconnected', 'Wallet has been disconnected.');
            showPage('landing');
        }, 1500);
    });

    // Initial page load logic
    window.addEventListener('load', async () => {
        const connectedAddress = localStorage.getItem('connectedWallet');
        if (connectedAddress) {
            updateWalletUI(connectedAddress);
            showPage('home');
        } else {
            showPage('landing');
        }
        
        // Initial market data fetch on page load
        await loadMarketData();

        // Check for daily refresh
        const lastRefresh = await localforage.getItem('last-refresh');
        if (!lastRefresh || (Date.now() - lastRefresh) > 86400000) { // 24 hours
            console.log("Daily refresh triggered.");
            await loadMarketData();
            await localforage.setItem('last-refresh', Date.now());
        }
    });
    
    //
    // Miscellaneous
    //
    function renderTV(containerId, symbol) {
        if (!window.TradingView) return;
        new TradingView.widget({
            autosize: true, symbol: symbol, interval: '60', timezone: 'Etc/UTC', theme: 'dark',
            style: '1', locale: 'en', toolbar_bg: '#0d0f14', hide_side_toolbar: false,
            container_id: containerId
        });
    }

    function copyText(txt) {
        navigator.clipboard.writeText(txt).then(() => showModal('Copied!', 'Address copied to clipboard.'));
    }

    function toggleSearch(open) {
        get('searchSheet').classList.toggle('hidden', !open);
    }
    
    // Exporting functions to the global scope for button clicks
    window.showModal = showModal;
    window.hideModal = hideModal;
    window.showPage = showPage;
    window.openWalletModal = openWalletModal;
    window.closeWalletModal = closeWalletModal;
    window.copyText = copyText;
    window.toggleSearch = toggleSearch;
    window.selectSwapToken = selectSwapToken;
    window.closeTokenSelectModal = closeTokenSelectModal;

</script>
</body>
</html>
